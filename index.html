<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Design ‚Üí Code</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap');

  * { margin: 0; padding: 0; box-sizing: border-box; }

  :root {
    --bg: #0a0a0b;
    --surface: #141416;
    --surface2: #1c1c1f;
    --border: #2a2a2e;
    --text: #e4e4e7;
    --muted: #71717a;
    --accent: #a78bfa;
    --accent2: #818cf8;
    --green: #34d399;
    --amber: #fbbf24;
  }

  body {
    font-family: 'Inter', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Header */
  .header {
    padding: 20px 32px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .logo {
    font-size: 18px;
    font-weight: 700;
    letter-spacing: -0.5px;
  }
  .logo span { color: var(--accent); }
  .header-sub {
    font-size: 12px;
    color: var(--muted);
    font-weight: 400;
  }

  /* Layout */
  .app {
    display: flex;
    height: calc(100vh - 65px);
  }

  /* Left Panel - Drop Zone */
  .left-panel {
    width: 420px;
    min-width: 420px;
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    overflow-y: auto;
  }

  .drop-zone {
    margin: 16px;
    border: 2px dashed var(--border);
    border-radius: 12px;
    padding: 48px 24px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
    min-height: 240px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }
  .drop-zone:hover, .drop-zone.dragover {
    border-color: var(--accent);
    background: rgba(167, 139, 250, 0.04);
  }
  .drop-zone.has-images {
    padding: 8px;
    border-style: solid;
    border-color: var(--border);
    min-height: auto;
  }
  .drop-zone.has-images:hover {
    border-color: var(--accent);
  }
  .image-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 6px;
    width: 100%;
  }
  .image-thumb {
    position: relative;
    border-radius: 6px;
    overflow: hidden;
    aspect-ratio: 4/3;
    cursor: pointer;
  }
  .image-thumb img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 6px;
  }
  .image-thumb .remove-img {
    position: absolute;
    top: 4px;
    right: 4px;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: rgba(0,0,0,0.7);
    color: white;
    border: none;
    font-size: 11px;
    cursor: pointer;
    display: none;
    align-items: center;
    justify-content: center;
    line-height: 1;
  }
  .image-thumb:hover .remove-img { display: flex; }
  .image-thumb .img-label {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 2px 6px;
    background: rgba(0,0,0,0.6);
    font-size: 9px;
    color: var(--muted);
    text-align: center;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .add-more-btn {
    border: 1px dashed var(--border);
    border-radius: 6px;
    aspect-ratio: 4/3;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    color: var(--muted);
    cursor: pointer;
    transition: all 0.15s;
  }
  .add-more-btn:hover {
    border-color: var(--accent);
    color: var(--accent);
  }
  .drop-icon {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    background: var(--surface2);
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 16px;
    font-size: 24px;
  }
  .drop-title {
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 4px;
  }
  .drop-sub {
    font-size: 12px;
    color: var(--muted);
  }
  /* removed - using image grid now */
  .drop-zone input { display: none; }

  /* Prompt */
  .prompt-section {
    padding: 0 16px 16px;
  }
  .prompt-label {
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--muted);
    margin-bottom: 8px;
  }
  .prompt-input {
    width: 100%;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 12px 14px;
    color: var(--text);
    font-family: 'Inter', sans-serif;
    font-size: 13px;
    resize: vertical;
    min-height: 80px;
    outline: none;
    transition: border-color 0.2s;
  }
  .prompt-input:focus { border-color: var(--accent); }
  .prompt-input::placeholder { color: var(--muted); }

  /* Settings */
  .settings {
    padding: 0 16px 16px;
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }
  .setting-chip {
    font-size: 11px;
    padding: 6px 12px;
    border-radius: 20px;
    border: 1px solid var(--border);
    background: var(--surface);
    color: var(--muted);
    cursor: pointer;
    transition: all 0.15s;
    user-select: none;
  }
  .setting-chip:hover { border-color: var(--accent); color: var(--text); }
  .setting-chip.active {
    border-color: var(--accent);
    background: rgba(167, 139, 250, 0.1);
    color: var(--accent);
  }

  /* Generate Button */
  .generate-btn {
    margin: 0 16px 16px;
    padding: 12px;
    border-radius: 10px;
    border: none;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    color: white;
    font-family: 'Inter', sans-serif;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: opacity 0.2s, transform 0.1s;
  }
  .generate-btn:hover { opacity: 0.9; }
  .generate-btn:active { transform: scale(0.98); }
  .generate-btn:disabled {
    opacity: 0.4;
    cursor: not-allowed;
    transform: none;
  }

  /* Designer Quote */
  .quote-section {
    margin: 0 16px 16px;
    padding: 16px;
    background: var(--surface);
    border-radius: 10px;
    border-left: 3px solid var(--accent);
  }
  .quote-label {
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    color: var(--accent);
    margin-bottom: 8px;
  }
  .quote-text {
    font-size: 13px;
    line-height: 1.6;
    color: var(--text);
    font-style: italic;
  }
  .quote-meta {
    margin-top: 10px;
    font-size: 11px;
    color: var(--muted);
  }
  .quote-meta strong { color: var(--text); font-weight: 500; }

  /* Analysis Tags */
  .analysis-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-top: 12px;
  }
  .tag {
    font-size: 10px;
    padding: 3px 8px;
    border-radius: 4px;
    font-weight: 500;
    font-family: 'JetBrains Mono', monospace;
  }
  .tag.good { background: rgba(52, 211, 153, 0.1); color: var(--green); }
  .tag.warn { background: rgba(251, 191, 36, 0.1); color: var(--amber); }
  .tag.info { background: rgba(167, 139, 250, 0.1); color: var(--accent); }

  /* Right Panel - Output */
  .right-panel {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .output-tabs {
    display: flex;
    border-bottom: 1px solid var(--border);
    padding: 0 16px;
  }
  .output-tab {
    padding: 12px 16px;
    font-size: 12px;
    font-weight: 500;
    color: var(--muted);
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.15s;
  }
  .output-tab:hover { color: var(--text); }
  .output-tab.active {
    color: var(--accent);
    border-bottom-color: var(--accent);
  }

  .output-content {
    flex: 1;
    overflow: hidden;
    position: relative;
  }

  /* Code View */
  .code-view {
    height: 100%;
    overflow: auto;
    padding: 16px;
    display: none;
  }
  .code-view.active { display: block; }
  .code-view pre {
    font-family: 'JetBrains Mono', monospace;
    font-size: 12px;
    line-height: 1.7;
    color: #c9d1d9;
    white-space: pre-wrap;
    word-break: break-word;
  }

  /* Preview */
  .preview-view {
    height: 100%;
    display: none;
    background: white;
  }
  .preview-view.active { display: block; }
  .preview-view iframe {
    width: 100%;
    height: 100%;
    border: none;
  }

  /* Empty State */
  .empty-state {
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: var(--muted);
    gap: 12px;
  }
  .empty-state .icon { font-size: 40px; opacity: 0.3; }
  .empty-state p { font-size: 13px; }

  /* Loading */
  .loading-overlay {
    position: absolute;
    inset: 0;
    background: rgba(10, 10, 11, 0.85);
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 16px;
    z-index: 10;
  }
  .loading-overlay.active { display: flex; }
  .spinner {
    width: 32px;
    height: 32px;
    border: 3px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .loading-text {
    font-size: 13px;
    color: var(--muted);
  }
  .loading-step {
    font-size: 11px;
    color: var(--accent);
    font-family: 'JetBrains Mono', monospace;
  }

  /* Action buttons */
  .code-actions {
    position: absolute;
    top: 12px;
    right: 12px;
    display: flex;
    gap: 6px;
    z-index: 5;
  }
  .action-btn {
    padding: 6px 12px;
    border-radius: 6px;
    border: 1px solid var(--border);
    background: var(--surface);
    color: var(--muted);
    font-size: 11px;
    font-family: 'Inter', sans-serif;
    cursor: pointer;
    transition: all 0.15s;
    white-space: nowrap;
  }
  .action-btn:hover { color: var(--text); border-color: var(--accent); }
  .action-btn.primary {
    background: rgba(167, 139, 250, 0.1);
    border-color: var(--accent);
    color: var(--accent);
  }
  .action-btn.primary:hover { background: rgba(167, 139, 250, 0.2); }

  /* Export modal */
  .export-menu {
    position: absolute;
    top: 42px;
    right: 12px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 8px;
    z-index: 20;
    min-width: 260px;
    display: none;
    box-shadow: 0 8px 32px rgba(0,0,0,0.5);
  }
  .export-menu.active { display: block; }
  .export-item {
    display: flex;
    align-items: flex-start;
    gap: 10px;
    padding: 10px 12px;
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.1s;
  }
  .export-item:hover { background: var(--surface2); }
  .export-item .icon { font-size: 18px; flex-shrink: 0; margin-top: 1px; }
  .export-item .label { font-size: 12px; font-weight: 600; color: var(--text); }
  .export-item .desc { font-size: 10px; color: var(--muted); margin-top: 2px; line-height: 1.4; }

  /* API Key Modal */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 100;
  }
  .modal-overlay.active { display: flex; }
  .modal {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 32px;
    width: 400px;
    max-width: 90vw;
  }
  .modal h3 {
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 8px;
  }
  .modal p {
    font-size: 12px;
    color: var(--muted);
    margin-bottom: 16px;
    line-height: 1.5;
  }
  .modal input {
    width: 100%;
    padding: 10px 12px;
    border-radius: 8px;
    border: 1px solid var(--border);
    background: var(--bg);
    color: var(--text);
    font-family: 'JetBrains Mono', monospace;
    font-size: 12px;
    margin-bottom: 12px;
    outline: none;
  }
  .modal input:focus { border-color: var(--accent); }
  .modal button {
    width: 100%;
    padding: 10px;
    border-radius: 8px;
    border: none;
    background: var(--accent);
    color: white;
    font-weight: 600;
    cursor: pointer;
  }

  /* Responsive */
  @media (max-width: 800px) {
    .app { flex-direction: column; }
    .left-panel { width: 100%; min-width: auto; border-right: none; border-bottom: 1px solid var(--border); max-height: 50vh; }
  }
</style>
</head>
<body>

<div class="header">
  <div>
    <div class="logo">Design <span>‚Üí</span> Code</div>
    <div class="header-sub">Drop inspiration. Get production code.</div>
  </div>
  <div style="display:flex;gap:8px;align-items:center;">
    <button class="setting-chip" onclick="showApiModal()" id="apiStatus">‚öôÔ∏è API Key</button>
  </div>
</div>

<div class="app">
  <!-- Left: Input -->
  <div class="left-panel">
    <div class="drop-zone" id="dropZone" onclick="if(!this.classList.contains('has-images'))document.getElementById('fileInput').click()">
      <input type="file" id="fileInput" accept="image/*" multiple onchange="Array.from(this.files).forEach(handleFile)">
      <div class="drop-icon">üé®</div>
      <div class="drop-title">Drop your design inspiration</div>
      <div class="drop-sub">Screenshot, mockup, Dribbble shot, napkin sketch ‚Äî anything</div>
    </div>

    <div class="prompt-section">
      <div class="prompt-label">Who is this for?</div>
      <textarea class="prompt-input" id="audienceInput" style="min-height:50px" placeholder="e.g. 'Law firm partners, 40-60 yrs old, not tech savvy' or 'Gen Z podcast creators' or 'Enterprise SaaS buyers'"></textarea>
    </div>

    <div class="prompt-section">
      <div class="prompt-label">What are you building?</div>
      <textarea class="prompt-input" id="promptInput" placeholder="e.g. 'A shoppable podcast page where viewers can buy everything mentioned in the episode' or 'A CRM dashboard for legal assistants' ‚Äî be specific about the product"></textarea>
    </div>

    <div class="settings">
      <div class="prompt-label" style="width:100%;margin-bottom:4px">Output</div>
      <div class="setting-chip active" data-output="html" onclick="setOutput(this)">HTML/CSS</div>
      <div class="setting-chip" data-output="react" onclick="setOutput(this)">React + Tailwind</div>
      <div class="setting-chip" data-output="nextjs" onclick="setOutput(this)">Next.js</div>
      <div class="setting-chip" data-output="vue" onclick="setOutput(this)">Vue</div>
    </div>
    <div class="settings">
      <div class="prompt-label" style="width:100%;margin-bottom:4px">Style</div>
      <div class="setting-chip active" data-style="faithful" onclick="setStyle(this)">Faithful</div>
      <div class="setting-chip" data-style="improved" onclick="setStyle(this)">Improved</div>
      <div class="setting-chip" data-style="reimagined" onclick="setStyle(this)">Reimagined</div>
    </div>

    <div class="settings" id="enhancementSettings">
      <div class="prompt-label" style="width:100%;margin-bottom:4px">Enhancements</div>
      <div class="setting-chip" data-enhance="motion" onclick="toggleEnhance(this)">üé¨ Motion</div>
      <div class="setting-chip" data-enhance="glassmorphism" onclick="toggleEnhance(this)">ü™ü Glass</div>
      <div class="setting-chip" data-enhance="gradients" onclick="toggleEnhance(this)">üåà Gradients</div>
      <div class="setting-chip" data-enhance="3d" onclick="toggleEnhance(this)">üßä 3D Depth</div>
      <div class="setting-chip" data-enhance="particles" onclick="toggleEnhance(this)">‚ú® Particles</div>
      <div class="setting-chip" data-enhance="darkmode" onclick="toggleEnhance(this)">üåô Dark Mode</div>
      <div class="setting-chip" data-enhance="scroll" onclick="toggleEnhance(this)">üìú Scroll FX</div>
      <div class="setting-chip" data-enhance="microinteractions" onclick="toggleEnhance(this)">üëÜ Micro-interactions</div>
    </div>

    <button class="generate-btn" id="generateBtn" onclick="generate()" disabled>
      ‚ú® Generate Code
    </button>

    <div class="quote-section" id="quoteSection" style="display:none">
      <div class="quote-label">üé® Design Analysis</div>
      <div class="quote-text" id="quoteText"></div>
      <div class="quote-meta" id="quoteMeta"></div>
      <div class="analysis-tags" id="analysisTags"></div>
    </div>
  </div>

  <!-- Right: Output -->
  <div class="right-panel">
    <div class="output-tabs">
      <div class="output-tab active" data-tab="preview" onclick="switchTab(this)">Preview</div>
      <div class="output-tab" data-tab="code" onclick="switchTab(this)">Code</div>
    </div>
    <div class="output-content">
      <div class="loading-overlay" id="loading">
        <div class="spinner"></div>
        <div class="loading-text">Analyzing your design...</div>
        <div class="loading-step" id="loadingStep">Extracting layout patterns</div>
      </div>

      <div class="preview-view active" id="previewView">
        <div class="empty-state" id="emptyPreview">
          <div class="icon">‚óá</div>
          <p>Drop a design and hit generate</p>
        </div>
        <iframe id="previewFrame" style="display:none"></iframe>
      </div>

      <div class="code-view" id="codeView">
        <div class="code-actions">
          <button class="action-btn" onclick="copyCode()">üìã Copy Code</button>
          <button class="action-btn primary" onclick="toggleExportMenu()">üöÄ Export ‚ñæ</button>
        </div>
        <div class="export-menu" id="exportMenu">
          <div class="export-item" onclick="exportCursorPrompt()">
            <div class="icon">‚ö°</div>
            <div>
              <div class="label">Copy as Cursor Prompt</div>
              <div class="desc">Copies the code + context as a prompt you can paste into Cursor's chat. Includes file path, instructions to integrate.</div>
            </div>
          </div>
          <div class="export-item" onclick="exportClaudePrompt()">
            <div class="icon">ü§ñ</div>
            <div>
              <div class="label">Copy as Claude/ChatGPT Prompt</div>
              <div class="desc">Full context prompt with design specs, audience, and code ‚Äî paste into any LLM to iterate.</div>
            </div>
          </div>
          <div class="export-item" onclick="downloadFile()">
            <div class="icon">üíæ</div>
            <div>
              <div class="label">Download File</div>
              <div class="desc">Save as .html, .tsx, .vue ‚Äî ready to drop into your project.</div>
            </div>
          </div>
          <div class="export-item" onclick="exportComponentSpec()">
            <div class="icon">üìê</div>
            <div>
              <div class="label">Copy Component Spec</div>
              <div class="desc">Design tokens, spacing, colors, typography extracted as a spec doc for your team or AI agent.</div>
            </div>
          </div>
        </div>
        <pre id="codeOutput"></pre>
      </div>
    </div>
  </div>
</div>

<!-- API Key Modal -->
<div class="modal-overlay" id="apiModal">
  <div class="modal">
    <h3>Anthropic API Key</h3>
    <p>Enter your Claude API key for vision analysis. Stored locally in your browser only ‚Äî never sent anywhere except Anthropic's API.</p>
    <input type="password" id="apiKeyInput" placeholder="sk-ant-api03-..." />
    <button onclick="saveApiKey()">Save Key</button>
  </div>
</div>

<script>
  let images = []; // {data, name}
  let outputFormat = 'html';
  let styleMode = 'faithful';
  let enhancements = new Set();
  let generatedCode = '';

  // Check for saved API key
  function getApiKey() {
    return localStorage.getItem('anthropic_api_key') || '';
  }
  function showApiModal() {
    document.getElementById('apiModal').classList.add('active');
    document.getElementById('apiKeyInput').value = getApiKey();
  }
  function saveApiKey() {
    const key = document.getElementById('apiKeyInput').value.trim();
    if (key) {
      localStorage.setItem('anthropic_api_key', key);
      document.getElementById('apiStatus').textContent = '‚úÖ API Key';
      document.getElementById('apiModal').classList.remove('active');
      updateGenerateBtn();
    }
  }
  if (getApiKey()) {
    document.getElementById('apiStatus').textContent = '‚úÖ API Key';
  }

  // Drag & Drop
  const dropZone = document.getElementById('dropZone');
  dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('dragover'); });
  dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
  dropZone.addEventListener('drop', e => {
    e.preventDefault();
    dropZone.classList.remove('dragover');
    const files = [...e.dataTransfer.files].filter(f => f.type.startsWith('image/'));
    handleFiles(files);
  });

  // Also handle paste
  document.addEventListener('paste', e => {
    const items = e.clipboardData?.items;
    if (!items) return;
    const files = [];
    for (const item of items) {
      if (item.type.startsWith('image/')) files.push(item.getAsFile());
    }
    if (files.length) handleFiles(files);
  });

  function handleFiles(files) {
    const toProcess = files.slice(0, 8 - images.length);
    if (!toProcess.length) return;
    let loaded = 0;
    toProcess.forEach(file => {
      const reader = new FileReader();
      reader.onload = e => {
        images.push({ data: e.target.result, name: file.name || `Image ${images.length + 1}` });
        loaded++;
        if (loaded === toProcess.length) {
          renderImageGrid();
          updateGenerateBtn();
        }
      };
      reader.readAsDataURL(file);
    });
  }

  function handleFile(file) {
    if (file) handleFiles([file]);
  }

  function removeImage(idx) {
    images.splice(idx, 1);
    renderImageGrid();
    updateGenerateBtn();
  }

  function renderImageGrid() {
    if (images.length === 0) {
      dropZone.classList.remove('has-images');
      dropZone.innerHTML = `<input type="file" id="fileInput" accept="image/*" multiple onchange="Array.from(this.files).forEach(handleFile)">
        <div class="drop-icon">üé®</div>
        <div class="drop-title">Drop your design inspiration</div>
        <div class="drop-sub">Screenshots, mockups, Dribbble shots ‚Äî drop multiple for a moodboard</div>`;
      return;
    }
    dropZone.classList.add('has-images');
    let html = `<input type="file" id="fileInput" accept="image/*" multiple onchange="Array.from(this.files).forEach(handleFile)">
      <div class="image-grid">`;
    images.forEach((img, i) => {
      html += `<div class="image-thumb">
        <img src="${img.data}" alt="${img.name}">
        <button class="remove-img" onclick="event.stopPropagation();removeImage(${i})">‚úï</button>
        <div class="img-label">${img.name.length > 15 ? img.name.slice(0,12)+'...' : img.name}</div>
      </div>`;
    });
    if (images.length < 8) {
      html += `<div class="add-more-btn" onclick="event.stopPropagation();document.getElementById('fileInput').click()">+</div>`;
    }
    html += `</div>`;
    dropZone.innerHTML = html;
  }

  function toggleEnhance(el) {
    const val = el.dataset.enhance;
    if (enhancements.has(val)) {
      enhancements.delete(val);
      el.classList.remove('active');
    } else {
      enhancements.add(val);
      el.classList.add('active');
    }
  }

  function setOutput(el) {
    el.parentElement.querySelectorAll('.setting-chip[data-output]').forEach(c => c.classList.remove('active'));
    el.classList.add('active');
    outputFormat = el.dataset.output;
  }
  function setStyle(el) {
    el.parentElement.querySelectorAll('.setting-chip[data-style]').forEach(c => c.classList.remove('active'));
    el.classList.add('active');
    styleMode = el.dataset.style;
  }

  function switchTab(el) {
    document.querySelectorAll('.output-tab').forEach(t => t.classList.remove('active'));
    el.classList.add('active');
    const tab = el.dataset.tab;
    document.getElementById('previewView').classList.toggle('active', tab === 'preview');
    document.getElementById('codeView').classList.toggle('active', tab === 'code');
  }

  function updateGenerateBtn() {
    document.getElementById('generateBtn').disabled = images.length === 0 || !getApiKey();
  }

  let lastAnalysis = null;

  function copyCode() {
    navigator.clipboard.writeText(generatedCode);
    showToast('Code copied!');
  }

  function toggleExportMenu() {
    document.getElementById('exportMenu').classList.toggle('active');
  }
  // Close export menu on outside click
  document.addEventListener('click', e => {
    const menu = document.getElementById('exportMenu');
    if (menu.classList.contains('active') && !e.target.closest('.export-menu') && !e.target.closest('.action-btn.primary')) {
      menu.classList.remove('active');
    }
  });

  function exportCursorPrompt() {
    const ext = { html: 'html', react: 'tsx', nextjs: 'tsx', vue: 'vue' }[outputFormat];
    const filename = `component.${ext}`;
    const audience = document.getElementById('audienceInput').value.trim();
    const product = document.getElementById('promptInput').value.trim();

    const prompt = `I have a design that was analyzed and converted to code. I need you to integrate it into my project.

${audience ? `**Target Audience:** ${audience}` : ''}
${product ? `**Product:** ${product}` : ''}
${lastAnalysis ? `**Design Analysis:** ${lastAnalysis.quote}` : ''}
${lastAnalysis?.palette ? `**Color Palette:** ${lastAnalysis.palette}` : ''}
${lastAnalysis?.typography ? `**Typography:** ${lastAnalysis.typography}` : ''}

**Generated Code (${outputFormat.toUpperCase()}):**
Save this to \`${filename}\` and integrate it:

\`\`\`${ext}
${generatedCode}
\`\`\`

**Instructions:**
1. Create the file at the appropriate location in my project
2. Wire up any imports needed
3. Replace placeholder content with real data from my app
4. Connect any click handlers / navigation to my router
5. Ensure it matches my existing design system (adjust tokens if needed)
6. Add any missing TypeScript types
7. Test responsiveness at 375px, 768px, 1440px`;

    navigator.clipboard.writeText(prompt);
    showToast('Cursor prompt copied! Paste into Cursor chat.');
    toggleExportMenu();
  }

  function exportClaudePrompt() {
    const audience = document.getElementById('audienceInput').value.trim();
    const product = document.getElementById('promptInput').value.trim();
    const activeEnhance = [...enhancements].join(', ');

    const prompt = `I'm building a UI and need your help iterating on this design.

## Context
${audience ? `- **Who it's for:** ${audience}` : '- Audience: General'}
${product ? `- **What I'm building:** ${product}` : ''}
- **Output format:** ${outputFormat.toUpperCase()}
- **Style:** ${styleMode}
${activeEnhance ? `- **Enhancements:** ${activeEnhance}` : ''}

## Design Analysis
${lastAnalysis ? `"${lastAnalysis.quote}"` : 'See code below.'}
${lastAnalysis?.palette ? `- **Palette:** ${lastAnalysis.palette}` : ''}
${lastAnalysis?.typography ? `- **Typography:** ${lastAnalysis.typography}` : ''}

## Current Code
\`\`\`
${generatedCode}
\`\`\`

## What I want to change
[DESCRIBE YOUR CHANGES HERE]

Keep the same visual language and quality level. Make it production-ready.`;

    navigator.clipboard.writeText(prompt);
    showToast('LLM prompt copied! Paste into Claude, ChatGPT, etc.');
    toggleExportMenu();
  }

  function downloadFile() {
    const ext = { html: 'html', react: 'tsx', nextjs: 'tsx', vue: 'vue' }[outputFormat];
    const blob = new Blob([generatedCode], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `design-output.${ext}`;
    a.click();
    URL.revokeObjectURL(url);
    showToast(`Downloaded design-output.${ext}`);
    toggleExportMenu();
  }

  function exportComponentSpec() {
    const audience = document.getElementById('audienceInput').value.trim();
    const product = document.getElementById('promptInput').value.trim();

    const spec = `# Component Design Spec
Generated by Design ‚Üí Code

## Product
${product || 'Not specified'}

## Audience
${audience || 'Not specified'}

## Visual Design
${lastAnalysis ? `### Designer Notes\n"${lastAnalysis.quote}"` : ''}
${lastAnalysis?.palette ? `\n### Color Palette\n${lastAnalysis.palette}` : ''}
${lastAnalysis?.typography ? `\n### Typography\n${lastAnalysis.typography}` : ''}

### Tags
${lastAnalysis?.tags?.map(t => `- [${t.type.toUpperCase()}] ${t.label}`).join('\n') || 'None'}

## Style Mode
${styleMode}

## Enhancements
${[...enhancements].join(', ') || 'None'}

## Output Format
${outputFormat.toUpperCase()}

## Source Code
\`\`\`
${generatedCode}
\`\`\`
`;

    navigator.clipboard.writeText(spec);
    showToast('Component spec copied!');
    toggleExportMenu();
  }

  function showToast(msg) {
    let toast = document.getElementById('toast');
    if (!toast) {
      toast = document.createElement('div');
      toast.id = 'toast';
      toast.style.cssText = 'position:fixed;bottom:24px;left:50%;transform:translateX(-50%);padding:10px 20px;background:var(--accent);color:white;border-radius:8px;font-size:13px;font-weight:500;z-index:200;opacity:0;transition:opacity 0.2s;pointer-events:none;';
      document.body.appendChild(toast);
    }
    toast.textContent = msg;
    toast.style.opacity = '1';
    setTimeout(() => toast.style.opacity = '0', 2000);
  }

  function buildReactPreview(code) {
    // Strip TypeScript types, imports, and export ‚Äî extract the JSX
    let cleaned = code
      // Remove import lines
      .replace(/^import\s+.*$/gm, '')
      // Remove export default/export
      .replace(/^export\s+default\s+/gm, '')
      .replace(/^export\s+/gm, '')
      // Remove TypeScript type annotations from function params
      .replace(/:\s*React\.\w+(<[^>]*>)?/g, '')
      .replace(/:\s*\w+(\[\])?\s*(?=[,\)=\{])/g, '')
      // Remove interface/type blocks
      .replace(/^(interface|type)\s+\w+\s*\{[^}]*\}/gm, '')
      .replace(/^(interface|type)\s+\w+\s*=[^;]+;/gm, '')
      // Remove 'use client' directive
      .replace(/^['"]use client['"];?\s*/gm, '')
      .trim();

    return `<!DOCTYPE html>
<html><head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://unpkg.com/react@18/umd/react.production.min.js"><\/script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"><\/script>
<script src="https://unpkg.com/@babel/standalone@7/babel.min.js"><\/script>
<script src="https://cdn.tailwindcss.com"><\/script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  body { font-family: 'Inter', sans-serif; margin: 0; }
  * { box-sizing: border-box; }
</style>
<script>
  // Provide common React hooks globally
  const { useState, useEffect, useRef, useMemo, useCallback, Fragment } = React;
  // Stub next/image, next/link, lucide-react
  const Image = (props) => React.createElement('img', {...props, src: props.src || ''});
  const Link = (props) => React.createElement('a', {...props, href: props.href || '#'});
<\/script>
</head><body>
<div id="root"></div>
<script type="text/babel" data-type="module">
${cleaned}

// Find the component (last function declaration or arrow function assignment)
const __components = {};
${cleaned.match(/(?:function|const)\s+([A-Z]\w*)/g)?.map(m => {
      const name = m.replace(/^(?:function|const)\s+/, '');
      return `try { __components['${name}'] = ${name}; } catch(e) {}`;
    }).join('\n') || ''}

// Render the last defined component
const __names = Object.keys(__components);
const __App = __components[__names[__names.length - 1]];
if (__App) {
  ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(__App));
} else {
  document.getElementById('root').innerHTML = '<div style="padding:40px;color:#888;font-family:monospace;">Could not auto-detect component to render. Check the Code tab.</div>';
}
<\/script>
</body></html>`;
  }

  function buildVuePreview(code) {
    // Extract template, script, and style from SFC
    const templateMatch = code.match(/<template>([\s\S]*?)<\/template>/);
    const styleMatch = code.match(/<style[^>]*>([\s\S]*?)<\/style>/);
    const scriptMatch = code.match(/<script[^>]*>([\s\S]*?)<\/script>/);

    const template = templateMatch ? templateMatch[1] : '<div>Could not extract template</div>';
    const style = styleMatch ? styleMatch[1] : '';
    const script = scriptMatch ? scriptMatch[1]
      .replace(/^import\s+.*$/gm, '')
      .replace(/export\s+default\s*/, 'const __component = ')
      : 'const __component = {}';

    return `<!DOCTYPE html>
<html><head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"><\/script>
<script src="https://cdn.tailwindcss.com"><\/script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
  body { font-family: 'Inter', sans-serif; margin: 0; }
  ${style}
</style>
</head><body>
<div id="app">${template}</div>
<script>
  ${script}
  const app = Vue.createApp(__component || {});
  app.mount('#app');
<\/script>
</body></html>`;
  }

  const loadingSteps = [
    'Extracting layout patterns',
    'Analyzing color palette',
    'Identifying typography',
    'Mapping component hierarchy',
    'Evaluating spacing & alignment',
    'Generating production code',
    'Polishing details'
  ];

  async function generate() {
    if (images.length === 0 || !getApiKey()) return;

    const btn = document.getElementById('generateBtn');
    const loading = document.getElementById('loading');
    btn.disabled = true;
    btn.textContent = '‚è≥ Generating...';
    loading.classList.add('active');

    // Animate loading steps
    let stepIdx = 0;
    const stepInterval = setInterval(() => {
      stepIdx = (stepIdx + 1) % loadingSteps.length;
      document.getElementById('loadingStep').textContent = loadingSteps[stepIdx];
    }, 2000);

    const prompt = document.getElementById('promptInput').value.trim();
    const audience = document.getElementById('audienceInput').value.trim();

    const formatInstructions = {
      html: 'Output a single self-contained HTML file with embedded CSS and JS. Use modern CSS (grid, flexbox, custom properties). Include Google Fonts if appropriate.',
      react: 'Output a single React component file using Tailwind CSS classes. Use TypeScript. Export default the component. Include all subcomponents in the same file.',
      nextjs: 'Output a Next.js page component (App Router) using Tailwind CSS and TypeScript. Use server components where appropriate.',
      vue: 'Output a single Vue 3 SFC (.vue file) with <script setup> and scoped styles.'
    };

    const styleInstructions = {
      faithful: 'Recreate the design as faithfully as possible. Match colors, spacing, typography, and layout exactly.',
      improved: 'Use the design as a starting point but improve it ‚Äî better spacing, more consistent typography, smoother animations, accessibility improvements. Make it feel more polished.',
      reimagined: 'Take the core concept and reimagine it with a fresh, modern aesthetic. Keep the same functionality but make it dramatically more beautiful and creative.'
    };

    const audienceContext = audience ? `\n\nTARGET AUDIENCE: ${audience}\nDesign decisions must be appropriate for this audience. Consider their tech literacy, aesthetic preferences, device usage patterns, and what builds trust with them.` : '';
    const productContext = prompt ? `\n\nPRODUCT CONTEXT: ${prompt}\nThis is what's being built. The design must serve this product's goals. Every UI decision should make this product more compelling and usable.` : '';

    const enhanceMap = {
      motion: 'Add tasteful CSS animations and transitions ‚Äî entrance animations (fade-in, slide-up), hover transforms, smooth state transitions. Use @keyframes for hero sections. Keep it elegant, not flashy.',
      glassmorphism: 'Use glassmorphism effects ‚Äî backdrop-filter: blur(), semi-transparent backgrounds with subtle borders, frosted glass cards. Layer depth with overlapping translucent panels.',
      gradients: 'Use rich gradient backgrounds, gradient text (background-clip: text), gradient borders, and mesh-gradient-style sections. Make colors flow and feel alive.',
      '3d': 'Add 3D depth with CSS transforms ‚Äî perspective, rotateX/Y on cards, parallax-style layering, subtle translateZ for hover states, box-shadows that create depth illusion.',
      particles: 'Add a subtle animated particle/dot background using pure CSS or minimal JS canvas. Keep it performant ‚Äî no heavy libraries. Stars, dots, or floating shapes.',
      darkmode: 'Design in dark mode with proper contrast. Rich dark backgrounds (#0a0a0b to #1a1a2e range), light text, accent colors that pop against dark. Include a dark/light toggle if appropriate.',
      scroll: 'Add scroll-driven animations using Intersection Observer ‚Äî elements fade in, slide up, or scale as they enter viewport. Parallax on hero sections. Sticky headers with blur on scroll.',
      microinteractions: 'Add detailed micro-interactions ‚Äî button press animations (scale down then up), input focus glow effects, checkbox/toggle animations, ripple effects on click, loading skeleton states, tooltip animations, cursor effects.'
    };

    const activeEnhancements = [...enhancements].map(e => enhanceMap[e]).filter(Boolean);
    const enhanceInstructions = activeEnhancements.length > 0
      ? `\n\nENHANCEMENTS TO APPLY:\n${activeEnhancements.map((e, i) => `${i+1}. ${e}`).join('\n')}\n\nThese are NOT optional ‚Äî implement each one. They should feel cohesive together, not bolted on.`
      : '';

    const multiImageContext = images.length > 1
      ? `\n\nMULTIPLE REFERENCE IMAGES: You're receiving ${images.length} design references. Treat them as a MOODBOARD ‚Äî synthesize the best elements from each into one cohesive design. Extract the layout from one, the color palette from another, typography choices, component styles, etc. Call out which elements you pulled from which image in your analysis.`
      : '';

    const systemPrompt = `You are an elite UI designer and frontend engineer with 15 years of experience shipping products at companies like Linear, Vercel, Stripe, and Apple. You analyze design screenshots and produce production-quality code that's better than what most agencies deliver.

Your response MUST be in this exact JSON format:
{
  "analysis": {
    "quote": "A brief, opinionated designer's take on this UI ‚Äî what works, what doesn't, what you'd change. Reference specific elements. Be the designer they hired, not a chatbot. 2-3 sentences max.",
    "tags": [
      {"label": "tag text", "type": "good|warn|info"}
    ],
    "palette": "Brief description of the color palette with hex values",
    "typography": "Font families, weights, and scale observed"
  },
  "code": "The complete code here as a string"
}
${audienceContext}${productContext}

Rules:
- The code must be COMPLETE and RUNNABLE ‚Äî no placeholders, no "add your content here"
- Use real, thoughtful placeholder content that makes the demo look alive and believable for the target audience
- Every pixel matters. Spacing, alignment, shadows, transitions ‚Äî get them right.
- ${formatInstructions[outputFormat]}
- ${styleInstructions[styleMode]}
- Responsive by default ‚Äî test at 375px, 768px, and 1440px mentally
- Smooth micro-interactions: hover states, focus rings, transitions on state changes
- Accessibility: proper contrast ratios, focus management, semantic HTML, aria labels
- If the audience is specified, tailor the visual language to what resonates with them
- Make it feel like a REAL product, not a demo. This should impress investors.
- IMPORTANT: Return ONLY valid JSON. No markdown, no code fences, no explanation outside the JSON.${enhanceInstructions}${multiImageContext}`;

    let userPrompt = 'Analyze this design and build it as a real product UI.';
    if (audience && prompt) {
      userPrompt = `Build this from the attached design inspiration. This is for: ${audience}. What I'm building: ${prompt}. Make every design decision serve this audience and product.`;
    } else if (prompt) {
      userPrompt = `Build this from the attached design inspiration. What I'm building: ${prompt}`;
    } else if (audience) {
      userPrompt = `Analyze this design and build it. Target audience: ${audience}. Tailor the design for them.`;
    }

    try {
      // Build content array with all images
      const content = [];
      images.forEach((img, i) => {
        const [header, base64] = img.data.split(',');
        const mediaType = header.match(/:(.*?);/)[1];
        if (images.length > 1) {
          content.push({ type: 'text', text: `[Reference image ${i + 1}: ${img.name}]` });
        }
        content.push({ type: 'image', source: { type: 'base64', media_type: mediaType, data: base64 } });
      });
      content.push({ type: 'text', text: userPrompt });

      const response = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-api-key': getApiKey(),
          'anthropic-version': '2023-06-01',
          'anthropic-dangerous-direct-browser-access': 'true'
        },
        body: JSON.stringify({
          model: 'claude-opus-4-6',
          max_tokens: 16000,
          system: systemPrompt,
          messages: [{
            role: 'user',
            content
          }]
        })
      });

      if (!response.ok) {
        const err = await response.json();
        throw new Error(err.error?.message || `API error: ${response.status}`);
      }

      const data = await response.json();
      const text = data.content[0].text;

      // Parse JSON response
      let result;
      try {
        // Try to find JSON in the response
        const jsonMatch = text.match(/\{[\s\S]*\}/);
        result = JSON.parse(jsonMatch ? jsonMatch[0] : text);
      } catch (parseErr) {
        // If JSON parse fails, treat entire response as code
        result = {
          analysis: { quote: "Couldn't parse structured response, but here's your code.", tags: [], palette: '', typography: '' },
          code: text
        };
      }

      // Save analysis for exports
      lastAnalysis = result.analysis;

      // Show analysis
      const quoteSection = document.getElementById('quoteSection');
      document.getElementById('quoteText').textContent = `"${result.analysis.quote}"`;
      document.getElementById('quoteMeta').innerHTML = `<strong>Palette:</strong> ${result.analysis.palette || 'Analyzed'} ¬∑ <strong>Type:</strong> ${result.analysis.typography || 'Detected'}`;

      const tagsEl = document.getElementById('analysisTags');
      tagsEl.innerHTML = (result.analysis.tags || []).map(t =>
        `<span class="tag ${t.type}">${t.label}</span>`
      ).join('');
      quoteSection.style.display = 'block';

      // Show code
      generatedCode = result.code;
      document.getElementById('codeOutput').textContent = generatedCode;

      // Show preview
      const frame = document.getElementById('previewFrame');
      const emptyPreview = document.getElementById('emptyPreview');
      emptyPreview.style.display = 'none';
      frame.style.display = 'block';

      // Render preview based on output format
      if (outputFormat === 'html') {
        frame.srcdoc = generatedCode;
      } else if (outputFormat === 'react' || outputFormat === 'nextjs') {
        // Transform React/Next.js TSX ‚Üí renderable HTML using Babel standalone + React CDN
        const reactPreview = buildReactPreview(generatedCode);
        frame.srcdoc = reactPreview;
      } else if (outputFormat === 'vue') {
        const vuePreview = buildVuePreview(generatedCode);
        frame.srcdoc = vuePreview;
      }

      // Switch to preview tab
      document.querySelector('.output-tab[data-tab="preview"]').click();

    } catch (err) {
      alert(`Error: ${err.message}`);
      console.error(err);
    } finally {
      clearInterval(stepInterval);
      loading.classList.remove('active');
      btn.disabled = false;
      btn.textContent = '‚ú® Generate Code';
    }
  }
</script>
</body>
</html>
